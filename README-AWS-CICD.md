# HospoMate - AWS CI/CD Pipeline & Infrastructure Guide

This document explains the Continuous Integration (CI) and Continuous Deployment (CD) pipelines, as well as the AWS infrastructure architecture for the HospoMate application.

The infrastructure is provisioned using **AWS Cloud Development Kit (CDK)** in Java and deployments are fully automated using **GitHub Actions**.

---

## üèóÔ∏è Architecture Overview

The system is designed for high security, scalability, and zero-downtime deployments.

1. **Frontend**: React SPA deployed to a private **Amazon S3** bucket. It is served globally via an **Amazon CloudFront** distribution. The S3 bucket is secured using Origin Access Control (OAC), meaning it cannot be accessed directly from the public internet.
2. **Backend**: Spring Boot 3 Java application containerized with Docker. It runs on **Amazon ECS (Elastic Container Service)** powered by **AWS Fargate** (serverless compute). The backend sits behind an **Application Load Balancer (ALB)**.
3. **Database**: **Amazon RDS** running PostgreSQL 15. The database resides entirely within private subnets, heavily isolated from the public internet.
4. **Security & Secrets**: We strictly follow a **zero-secrets in codebase** policy.
   - Database credentials are automatically generated by CDK and securely stored in **AWS Secrets Manager**.
   - During startup, Fargate natively retrieves these secrets from Secrets Manager and injects them into the running container as environment variables.
   - GitHub Actions authenticates to AWS using **OIDC (OpenID Connect)**. No long-lived static AWS access keys are stored in GitHub Secrets.

---

## üöÄ CI/CD Pipelines (GitHub Actions)

There are three distinct pipelines triggering automatically when code is pushed to the `main` branch. You can find them in the `.github/workflows/` directory.

### 1. Infrastructure Pipeline (`deploy-infrastructure.yml`)
**Trigger**: Changes to the `infrastructure/**` directory.
- **CI**: Compiles the Java CDK code (`mvn package`) to verify syntax and structural integrity.
- **CD**: Runs `cdk deploy --all` to automatically provision or update AWS CloudFormation stacks (VPC, RDS, ECS, S3, CloudFront).

### 2. Backend Pipeline (`deploy-backend.yml`)
**Trigger**: Changes to the `backend/**` directory.
- **CI**: 
  - Checks out the code and sets up Java 17.
  - Builds the Spring Boot application using Maven (`mvn clean package -DskipTests`).
- **CD**:
  - Authenticates to AWS via the OIDC IAM Role.
  - Builds the Docker image based on `backend/Dockerfile`.
  - Tags and pushes the new Docker image to **Amazon ECR (Elastic Container Registry)**.
  - Forces a rolling update on the ECS Fargate service (`aws ecs update-service --force-new-deployment`). ECS gracefully starts the new container, drains traffic from the old one, and tears the old one down.

### 3. Frontend Pipeline (`deploy-frontend.yml`)
**Trigger**: Changes to the `frontend/**` directory.
- **CI**: Runs `npm ci` and `npm run build` to compile and bundle the React application using Node 18.
- **CD**:
  - Authenticates to AWS via the OIDC IAM Role.
  - Uses the AWS CLI to sync the compiled `dist/` folder directly to the secure S3 bucket (`aws s3 sync ... --delete`).
  - Triggers a cache invalidation on Amazon CloudFront to ensure users immediately receive the latest version of the application.

---

## üîê Authentication via AWS OIDC (OpenID Connect)

Instead of storing dangerous, long-lived AWS IAM User credentials in GitHub, we use **OpenID Connect**.

When GitHub Actions runs, it requests a temporary, short-term token from GitHub's identity provider. It presents this token to AWS. AWS validates the token's signature, checks if the request is coming from your specific repository (`Vikrantgupta01/hospomate`), and responds by issuing short-term AWS credentials.

The rules for this are defined in `infrastructure/src/main/java/com/myorg/OidcRoleStack.java`.

---

## üõ†Ô∏è How to Perform Your First Deployment

Because GitHub currently has *no access* to your AWS account, **you must perform the initial deployment manually** from your local machine to establish the secure OIDC trust relationship.

### Prerequisites
- AWS CLI installed and configured locally (`aws configure`) with Administrator credentials.
- Node.js (v18+) and AWS CDK CLI installed (`npm install -g aws-cdk`).
- Java 17 and Maven installed.

### Step 1: Bootstrap your AWS Environment
Bootstrapping provisions initial resources (like an S3 bucket for CloudFormation assets) required by CDK. Run this once per AWS account/region.
```bash
cd infrastructure
cdk bootstrap
```

### Step 2: Deploy the OIDC Role Stack
Deploy the IAM Role that GitHub Actions will assume.
```bash
cdk run --app "mvn -q exec:java" deploy OidcRoleStack
```
*(Note: Be sure your AWS CLI is authenticated correctly).*

### Step 3: Update GitHub Actions Workflows
After the `OidcRoleStack` deploys, you will see a Role ARN in the AWS IAM Console. 
Update the 3 workflow files in `.github/workflows/`:
1. Find the placeholder: `role-to-assume: arn:aws:iam::<YOUR_AWS_ACCOUNT_ID>:role/GitHubActionsDeployRole`
2. Replace `<YOUR_AWS_ACCOUNT_ID>` with your actual 12-digit AWS Account ID.

### Step 4: Initial Full Deployment
Once the workflows are updated and pushed to GitHub:
1. GitHub Actions will now have permission to deploy the full infrastructure.
2. Go to the **Actions** tab in your GitHub repository.
3. Manually trigger the **"Deploy Infrastructure (CDK)"** workflow. Wait for it to finish.
4. Obtain the generated `ECR Repository Name`, `ECS Service Name`, `S3 Bucket Name`, and `CloudFront Distribution ID` from the AWS Console or CDK outputs.
5. Update the `<YOUR_BUCKET_NAME>`, `<YOUR_DISTRIBUTION_ID>`, and `<YOUR_ECS_SERVICE_NAME>` placeholders inside `deploy-frontend.yml` and `deploy-backend.yml`.
6. Commit the changes and push to `main`! Your backend and frontend will now automatically deploy.

---

## üõ°Ô∏è Viewing Database Secrets
Because the password is auto-generated by AWS CDK:
1. Log into the AWS Management Console.
2. Open **AWS Secrets Manager**.
3. Look for a secret starting with `HospoDbSecret...`.
4. Click **"Retrieve secret value"** to view your PostgreSQL connection details.
